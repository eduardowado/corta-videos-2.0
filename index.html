<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="coi-serviceworker.js"></script>
    <title>Cortador PRO V5 (Streamer)</title>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: white; padding: 20px; text-align: center; }
        .container { background: #2d2d2d; padding: 20px; border-radius: 12px; max-width: 600px; margin: 0 auto; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        h1 { color: #ff9900; }
        input, select { width: 100%; padding: 10px; margin: 5px 0; border-radius: 8px; border: none; }
        input { background: #404040; color: white; }
        button { background: #007bff; color: white; padding: 15px; width: 100%; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 10px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #555; cursor: wait; }
        .mode-select { background: #333; color: white; border: 1px solid #555; font-size: 16px; }
        .clip-card { background: #404040; margin-top: 15px; padding: 10px; border-radius: 8px; border-left: 5px solid #ff9900; text-align: left; }
        .btn-dl { display: inline-block; padding: 8px 15px; margin-top: 5px; border-radius: 5px; text-decoration: none; color: white; font-size: 14px; }
        .dl-green { background: #28a745; }
        .dl-purple { background: #6f42c1; }
        #status { margin-top: 10px; color: #aaa; font-style: italic; }
    </style>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>üçï Pizza Cutter V5</h1>
        
        <input type="file" id="uploader" accept="video/*">
        
        <div style="display: flex; gap: 10px;">
            <input type="number" id="start" placeholder="Inicio (seg)" value="0">
            <input type="number" id="end" placeholder="Fin (seg)" value="10">
        </div>

        <label style="display:block; text-align:left; margin-top:10px; color:#aaa;">üì∫ Estilo de Video:</label>
        <select id="mode" class="mode-select">
            <option value="zoom">üì± Zoom Central (Normal)</option>
            <option value="streamer">üéÆ Streamer (Juego abajo + Cara arriba)</option>
        </select>

        <button id="processBtn" onclick="procesar()">‚úÇÔ∏è GENERAR CLIP</button>
        <div id="status">Listo para cortar.</div>
        <div id="gallery"></div>
    </div>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: true });
        let videoCargado = false;

        async function init() {
            try { await ffmpeg.load(); document.getElementById('status').innerText = "‚úÖ Motor listo."; }
            catch(e) { document.getElementById('status').innerText = "‚ùå Error: Falta la llave .js en GitHub"; }
        }
        init();

        document.getElementById('uploader').addEventListener('change', () => { videoCargado = false; });

        async function procesar() {
            const files = document.getElementById('uploader').files;
            const start = document.getElementById('start').value;
            const end = document.getElementById('end').value;
            const mode = document.getElementById('mode').value;

            if (!files.length) return alert("Sube video");
            
            const btn = document.getElementById('processBtn');
            btn.disabled = true;
            document.getElementById('status').innerText = "‚è≥ Trabajando... (Paciencia)";

            try {
                if (!videoCargado) {
                    ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(files[0]));
                    videoCargado = true;
                }

                const outName = `clip_${Date.now()}.mp4`;
                let comando = [];

                if (mode === 'zoom') {
                    // MODO 1: Zoom simple al centro (Tiktok estilo CapCut)
                    // Corta tiempo (-ss -to) y recorta centro (crop)
                    comando = ['-i', 'input.mp4', '-ss', start, '-to', end, 
                               '-vf', 'crop=ih*(9/16):ih,scale=720:1280', 
                               '-c:v', 'libx264', '-preset', 'ultrafast', outName];
                } else {
                    // MODO 2: STREAMER (La Magia)
                    // Divide la pantalla: Camara (esq superior izq) arriba, Juego (centro) abajo
                    // Ajusta "crop=..." si tu c√°mara est√° en otro lado
                    comando = ['-i', 'input.mp4', '-ss', start, '-to', end,
                               '-filter_complex', 
                               '[0:v]crop=960:540:0:0,scale=720:640[cara];[0:v]crop=960:1080:960:0,scale=720:640[juego];[cara][juego]vstack=inputs=2', 
                               '-c:v', 'libx264', '-preset', 'ultrafast', outName];
                }

                await ffmpeg.run(...comando);

                const data = ffmpeg.FS('readFile', outName);
                const url = URL.createObjectURL(new Blob([data.buffer], {type: 'video/mp4'}));
                
                // Crear tarjeta
                const card = document.createElement('div');
                card.className = 'clip-card';
                card.innerHTML = `
                    <strong>‚è±Ô∏è ${start}s - ${end}s (${mode.toUpperCase()})</strong><br>
                    <a href="${url}" download="${outName}" class="btn-dl dl-purple">‚¨áÔ∏è Descargar Video</a>
                `;
                document.getElementById('gallery').prepend(card);
                
                document.getElementById('status').innerText = "‚ú® ¬°Terminado!";

            } catch (e) {
                console.error(e);
                alert("Error: Tu celular se qued√≥ sin memoria o el video es muy pesado.");
                document.getElementById('status').innerText = "‚ùå Fall√≥.";
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
